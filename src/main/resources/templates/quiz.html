<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ChestionareAuto360</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f6fa;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #222;
        }

        header {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #fff;
            padding: 1rem 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            gap: 1rem;
            flex-wrap: wrap;
        }

        header div {
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            color: #555;
        }

        header div strong {
            display: block;
            font-size: 1.3rem;
            color: #1c7ed6;
            margin-top: 0.2rem;
        }

main {
    flex: 0 0 auto;
    max-width: 2000px;
    margin: 2rem auto 10rem auto;
    padding: 2rem;
    background: #f5f6fa;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-height: 70vh;
    overflow-y: auto;
}
        .question-text {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    min-height: 3rem;
    color: #111;
}


        .options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

label {
    display: flex;
    align-items: center;
    cursor: pointer;
    background: #fff;
    border-radius: 12px;
    padding: 1.2rem 2rem;
    font-weight: 600;
    font-size: 1.2rem;
    color: #555;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    border: none;
    min-width: 850px;
}

        label:hover {
            border-color: #1c7ed6;
            background: #e7f0ff;
        }

        input[type="checkbox"] {
            display: none;
        }

        .option-letter {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            background: #999;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-right: 1rem;
            flex-shrink: 0;
            transition: background 0.3s ease;
        }

        input[type="checkbox"]:checked + .option-letter {
            background: #fff59d;
    color: #222;
        }

        label:has(input[type="checkbox"]:checked) {
            background: #bbdefb;
    color: #222;
    border-color: #90caf9;
        }

        footer {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        button {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0.9rem 2rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        button#laterBtn {
            background: transparent;
            border: 2px solid #ccc;
            color: #555;
        }

        button#laterBtn:hover {
            background: #eee;
            transform: scale(1.05);
        }

      button#submitBtn {
    background: #388e3c;
    color: white;
    border: none;
}

button#submitBtn:hover:not(:disabled):not(.inactive) {
    background: #2e7d32;
    transform: scale(1.05);
}


        button#submitBtn:disabled {
            background: #999;
            cursor: not-allowed;
        }

      button#modifyBtn {
    color: #d32f2f;
    border: 2px solid #d32f2f;
    background: transparent;
}

button#modifyBtn:hover:not(:disabled):not(.inactive) {
    background: #fddede;
    transform: scale(1.05);
}

        @media (max-width: 480px) {
            main {
                margin: 1rem;
                padding: 1.5rem;
            }
            header div {
                font-size: 0.9rem;
            }
            button {
                font-size: 1rem;
                padding: 0.7rem 1.5rem;
            }
        }
.home-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;
    color: #1c7ed6;
    margin-right: 1rem;
    transition: color 0.3s ease;
}

.home-btn:hover {
    color: #155bb5;
}
        footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #fff;
    padding: 2rem 2rem;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    gap: 2rem;
    z-index: 1000;
}

.question-text {
    font-size: 1.4rem;
    font-weight: 600;
    margin: 1.5rem auto;
    max-width: 720px;
    color: #111;
}
footer button#laterBtn,
footer button#modifyBtn,
footer button#submitBtn {
    font-size: 1.3rem;
    padding: 1.2rem 2.5rem;
    border-radius: 8px;
    min-width: 330px;
    justify-content: center;
}
        @media (max-width: 480px) {
    footer button#laterBtn,
    footer button#modifyBtn,
    footer button#submitBtn {
        font-size: 1.3rem;
        padding: 1rem 2rem;
    }
}
#timeRemaining {
    font-size: 2rem;
    color: #388e3c;
    font-weight: 700;
}
        button.inactive {
    background: #ccc !important;
    color: #666 !important;
    border: none !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}
    </style>
</head>
<body>
<header>
    <button class="home-btn" id="homeBtn" title="Acasă">
        <i class="fa fa-home"></i>
    </button>
    <div>Întrebări totale <strong id="totalQuestions">26</strong></div>
    <div>Întrebări rămase <strong id="questionsLeft">26</strong></div>
    <div>Timp rămas <strong id="timeRemaining">30:00</strong></div>
    <div>Corecte <strong id="correctAnswers">0</strong></div>
    <div>Greșite <strong id="wrongAnswers">0</strong></div>
</header>

<p class="question-text">Întrebarea 1</p>

<div id="finalMessage" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            justify-content:center; align-items:center; text-align:center; padding:2rem;
            font-size:2rem; font-weight:700; z-index:2000; background:#fff; color:#2e7d32; flex-direction:column; gap:2rem;">
    <p id="finalText"></p>
    <button onclick="window.location.href='/'"
            style="font-size:3rem; color:#1c7ed6; background:transparent; border:none; cursor:pointer;">
        <i class="fa fa-home"></i>
    </button>
</div>


<main>
    <form th:action="@{/quiz/submit}" method="post" id="quizForm" novalidate>
        <input type="hidden" id="totalQuestionsField" name="totalQuestions"/>
        <input type="hidden" id="correctAnswersField" name="correctAnswers"/>
        <input type="hidden" id="wrongAnswersField" name="wrongAnswers"/>
        <input type="hidden" id="categoryField" name="category" th:value="${quizName}"/>
        <div class="options"></div>
    </form>
</main>

<footer>
    <button type="button" id="laterBtn">
        <i class="fa fa-rotate-left"></i> Răspunde mai târziu
    </button>
    <button type="button" id="modifyBtn">
        <i class="fa fa-xmark"></i> Modifică răspunsul
    </button>
    <button type="button" id="submitBtn">
        <i class="fa fa-check"></i> Trimite răspunsul
    </button>
</footer>


<script th:inline="javascript">
    /*<![CDATA[*/
    const questions = /*[[${questions}]]*/ [];
    const quizName = /*[[${quizName}]]*/ "";


    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let wrongAnswers = 0;

    const questionTextEl = document.querySelector(".question-text");
    const optionsEl = document.querySelector(".options");
    const questionsLeftEl = document.getElementById('questionsLeft');
    const correctAnswersEl = document.getElementById('correctAnswers');
    const wrongAnswersEl = document.getElementById('wrongAnswers');
    const submitBtn = document.getElementById('submitBtn');

    const totalQuestionsField = document.getElementById("totalQuestionsField");
    const correctAnswersField = document.getElementById("correctAnswersField");
    const wrongAnswersField = document.getElementById("wrongAnswersField");
    const categoryField = document.getElementById("categoryField");

    const modifyBtn = document.getElementById('modifyBtn');
    const laterBtn = document.getElementById('laterBtn');
    const homeBtn = document.getElementById("homeBtn");


    function disableButtons() {
        submitBtn.disabled = true;
        submitBtn.classList.add("inactive");

        modifyBtn.disabled = true;
        modifyBtn.classList.add("inactive");
    }

    function enableButtons() {
        submitBtn.disabled = false;
        submitBtn.classList.remove("inactive");

        modifyBtn.disabled = false;
        modifyBtn.classList.remove("inactive");
    }


let timeLeft = 1800;
const timeRemainingEl = document.getElementById("timeRemaining");
const timeWarningSound = new Audio("/sounds/timeleft.mp3");

function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}:${sec < 10 ? "0" : ""}${sec}`;
}

let fiveMinuteWarningPlayed = false;
let countdownInterval;

       function countdown() {
    if (timeLeft > 0) {
        timeLeft--;
        timeRemainingEl.textContent = formatTime(timeLeft);

        if (timeLeft <= 300) {
            timeRemainingEl.style.color = "#d32f2f";

            if (!fiveMinuteWarningPlayed) {
                timeWarningSound.play().catch(err => console.log("Sound error:", err));
                fiveMinuteWarningPlayed = true;
            }
        } else {
            timeRemainingEl.style.color = "#388e3c";
        }
    } else {
        clearInterval(countdownInterval);
        alert('Timpul pentru chestionar a expirat!');
        finalizeQuiz(true);
    }
}

countdownInterval = setInterval(countdown, 1000);


    optionsEl.addEventListener('click', (e) => {
        const target = e.target;
        if(target.tagName === 'INPUT' && target.type === 'checkbox') {
            if(target.dataset.checkedOnce === 'true') {
                target.checked = true;
            } else {
                target.dataset.checkedOnce = 'true';
            }
        }
    });

    homeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("Ești sigur că vrei să închizi acest chestionar? Progresul nu va fi salvat.")) {
            window.location.href = "/";
        }
    });

    modifyBtn.addEventListener('click', () => {
        const allCheckboxes = optionsEl.querySelectorAll('input[type="checkbox"]');
        allCheckboxes.forEach(cb => {
            cb.checked = false;
            cb.dataset.checkedOnce = '';
        });
        disableButtons();
    });

    function loadQuestion(index){
        const q = questions[index];
        questionTextEl.textContent = q.text;
        optionsEl.innerHTML = `
            <label>
                <input type="checkbox" name="answer" value="A" />
                <span class="option-letter">A</span>
                <span>${q.optionA}</span>
            </label>
            <label>
                <input type="checkbox" name="answer" value="B" />
                <span class="option-letter">B</span>
                <span>${q.optionB}</span>
            </label>
            <label>
                <input type="checkbox" name="answer" value="C" />
                <span class="option-letter">C</span>
                <span>${q.optionC}</span>
            </label>
        `;
        questionsLeftEl.textContent = questions.length - currentQuestionIndex;
        disableButtons();

        const checkboxes = optionsEl.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.addEventListener('change', enableButtons));
    }

  function finalizeQuiz(isFailed = false) {
    totalQuestionsField.value = questions.length;
    correctAnswersField.value = correctAnswers;
    wrongAnswersField.value = wrongAnswers;
    categoryField.value = quizName;

    let message = "";
    let isWin = true;

    if (isFailed) {
        message = "Ați fost RESPINS la acest chestionar!";
        isWin = false;
    } else {
        message = `Ai fost declarat ADMIS! Scorul tău: ${correctAnswers}/${questions.length}`;
    }

    const formData = new FormData();
    formData.append("totalQuestions", questions.length);
    formData.append("correctAnswers", correctAnswers);
    formData.append("wrongAnswers", wrongAnswers);
    formData.append("category", quizName);

    fetch('/quiz/submit', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).catch(err => console.error(err));

    for (let el of document.body.children) {
        if(el.id !== "finalMessage") el.style.display = "none";
    }

    const finalMessageEl = document.getElementById("finalMessage");
    const finalTextEl = document.getElementById("finalText");
    finalMessageEl.style.display = "flex";
    finalTextEl.textContent = message;
    finalTextEl.style.color = isWin ? "#388e3c" : "#d32f2f";
}

    let waitingForNext = false;

    submitBtn.addEventListener('click', () => {
        if (!waitingForNext) {
            const selectedEls = optionsEl.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedEls.length === 0) return;

            const selectedValues = Array.from(selectedEls).map(el => el.value);
            const correctValues = questions[currentQuestionIndex].correctOption.split(",");

            const allCheckboxes = optionsEl.querySelectorAll('input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.disabled = true);

            allCheckboxes.forEach(cb => {
                const label = cb.parentElement;
                const letter = label.querySelector('.option-letter');

                if (correctValues.includes(cb.value)) {
                    label.style.background = "#c8e6c9";
                    letter.style.background = "#388e3c";
                    letter.style.color = "#fff";
                } else {
                    label.style.background = "#ffcdd2";
                    letter.style.background = "#d32f2f";
                    letter.style.color = "#fff";
                }
            });

           if (selectedValues.sort().join(",") === correctValues.sort().join(",")) {
    correctAnswers++;
} else {
    wrongAnswers++;
    if (wrongAnswers >= 5) {
        finalizeQuiz(true);
        return;
    }
}
            correctAnswersEl.textContent = correctAnswers;
            wrongAnswersEl.textContent = wrongAnswers;

            submitBtn.innerHTML = `<i class="fa fa-check"></i> Continuă`;
            modifyBtn.disabled = true;
            modifyBtn.style.background = "#ccc";
            modifyBtn.style.color = "#666";

            laterBtn.disabled = true;
            laterBtn.style.background = "#ccc";
            laterBtn.style.color = "#666";

            waitingForNext = true;

        } else {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                loadQuestion(currentQuestionIndex);
                disableButtons();
                submitBtn.innerHTML = `<i class="fa fa-check"></i> Trimite răspunsul`;

                const allCheckboxes = optionsEl.querySelectorAll('input[type="checkbox"]');
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.disabled = false;
                });

                modifyBtn.disabled = false;
                modifyBtn.style.background = "transparent";
                modifyBtn.style.color = "#d32f2f";

                laterBtn.disabled = false;
                laterBtn.style.background = "transparent";
                laterBtn.style.color = "#555";

                waitingForNext = false;
            } else {
                finalizeQuiz();
            }
        }
    });

    laterBtn.addEventListener('click', () => {
        const currentQuestion = questions[currentQuestionIndex];
        questions.push(currentQuestion);
        questions.splice(currentQuestionIndex, 1);

        if (questions.length > 0) {
            if (currentQuestionIndex >= questions.length) currentQuestionIndex = 0;
            loadQuestion(currentQuestionIndex);
        }

        const allCheckboxes = optionsEl.querySelectorAll('input[type="checkbox"]');
        allCheckboxes.forEach(cb => {
            cb.checked = false;
            cb.disabled = false;
            cb.dataset.checkedOnce = '';
        });

        modifyBtn.disabled = false;
        modifyBtn.style.background = "transparent";
        modifyBtn.style.color = "#d32f2f";

        laterBtn.disabled = false;
        laterBtn.style.background = "transparent";
        laterBtn.style.color = "#555";

        submitBtn.innerHTML = `<i class="fa fa-check"></i> Trimite răspunsul`;
        waitingForNext = false;
    });

    loadQuestion(currentQuestionIndex);
    /*]]>*/
</script>

</body>
</html>
